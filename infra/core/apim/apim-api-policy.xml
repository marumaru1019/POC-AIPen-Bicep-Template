<policies>
    <inbound>
        <base />
        <!-- Content-Type ヘッダーを設定 -->
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        <!-- トレース ID を含める設定 -->
        <set-header name="Ocp-Apim-Trace" exists-action="override">
            <value>true</value>
        </set-header>
        <!-- 乱数を一度生成 -->
        <set-variable name="randomNumber" value="@(new Random().Next(1, 3))" />
        <!-- ランダムにバックエンドサービスとAPIキーを設定 -->
        <choose>
            <when condition="@(context.Variables.GetValueOrDefault<int>("randomNumber", 0) == 1)">
                <set-backend-service base-url="https://eastus.api.cognitive.microsoft.com/openai" />
                <set-header name="api-key" exists-action="override">
                    <value>your_api_key1</value>
                </set-header>
            </when>
            <when condition="@(context.Variables.GetValueOrDefault<int>("randomNumber", 0) == 2)">
                <set-backend-service base-url="https://eastus.api.cognitive.microsoft.com/openai" />
                <set-header name="api-key" exists-action="override">
                    <value>your_api_key2</value>
                </set-header>
            </when>
        </choose>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
        <!-- Apim-Trace-Id ヘッダーをレスポンスに含める設定 -->
        <set-header name="Apim-Trace-Id" exists-action="append">
            <value>@(context.Request.Headers.GetValueOrDefault("Apim-Trace-Id", "trace-id-not-found"))</value>
        </set-header>
    </outbound>
    <on-error>
        <base />
        <!-- エラー時のフォールバックメカニズム -->
        <retry condition="@(context.Response.StatusCode != 200)" count="1" interval="0">
            <!-- 乱数を一度生成 -->
            <set-variable name="fallbackRandomNumber" value="@(new Random().Next(1, 3))" />
            <!-- ランダムに他のバックエンドサービスとAPIキーを設定 -->
            <choose>
                <when condition="@(context.Variables.GetValueOrDefault<int>("fallbackRandomNumber", 0) == 1)">
                    <set-backend-service base-url="https://eastus.api.cognitive.microsoft.com/openai" />
                    <set-header name="api-key" exists-action="override">
                        <value>your_api_key1</value>
                    </set-header>
                </when>
                <when condition="@(context.Variables.GetValueOrDefault<int>("fallbackRandomNumber", 0) == 2)">
                    <set-backend-service base-url="https://eastus.api.cognitive.microsoft.com/openai" />
                    <set-header name="api-key" exists-action="override">
                        <value>your_api_key2</value>
                    </set-header>
                </when>
            </choose>
        </retry>
    </on-error>
</policies>